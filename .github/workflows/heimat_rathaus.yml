name: Heimat Info Rathaus

on:
  workflow_dispatch:
    inputs:
      existing_post:
        description: "Postet zum Test auch bereits gesehene Beitraege"
        required: false
        default: "0"
  schedule:
    - cron: "0 7 * * *"

concurrency:
  group: heimat-info-rathaus
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Telegram Testnachricht
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          python - << 'PY'
          import os, json, datetime
          from urllib.request import Request, urlopen
          from urllib.parse import urlencode

          token = (os.environ.get("TG_TOKEN") or "").strip()
          chat_id = (os.environ.get("TG_CHAT_ID") or "").strip()
          if not token or not chat_id:
              raise SystemExit("TG_TOKEN oder TG_CHAT_ID fehlt in Secrets")

          event = os.environ.get("EVENT_NAME", "")
          repo = os.environ.get("REPO", "")
          ref = os.environ.get("REF", "")
          sha = (os.environ.get("SHA", "") or "")[:8]
          run_id = os.environ.get("RUN_ID", "")
          server = os.environ.get("SERVER_URL", "")
          run_url = f"{server}/{repo}/actions/runs/{run_id}"

          ts = datetime.datetime.utcnow().isoformat() + "Z"
          text = (
              "âœ… Telegram Testnachricht\n"
              f"Zeit: {ts}\n"
              f"Event: {event}\n"
              f"Branch: {ref}\n"
              f"Commit: {sha}\n"
              f"Run: {run_url}"
          )

          api = f"https://api.telegram.org/bot{token}/sendMessage"
          data = urlencode({
              "chat_id": chat_id,
              "text": text,
              "disable_web_page_preview": "true"
          }).encode("utf-8")

          req = Request(api, data=data, headers={"Content-Type": "application/x-www-form-urlencoded"})
          with urlopen(req, timeout=30) as resp:
              body = resp.read().decode("utf-8")

          print("Telegram raw:", body)
          j = json.loads(body)
          if not j.get("ok"):
              raise SystemExit("Telegram ok=false: " + body)

          print("OK, message_id:", (j.get("result") or {}).get("message_id"))
          PY

      - name: Run bot
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          EXISTING_POST: ${{ github.event_name == 'workflow_dispatch' && inputs.existing_post || '0' }}
        run: |
          python heimat_rathaus.py

      - name: Debug state
        run: |
          echo "event=${{ github.event_name }}"
          echo "existing_post=${{ inputs.existing_post }}"
          ls -la
          echo "----- state.json -----"
          if test -f state.json; then cat state.json; else echo "state.json fehlt"; fi

      - name: Commit state
        run: |
          if test -f state.json; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -f state.json
            git commit -m "Update state" || echo "Nothing to commit"
            git push
          else
            echo "state.json fehlt, nichts zu committen"
          fi
